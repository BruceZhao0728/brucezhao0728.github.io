<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="My Blog Posts">
    <title>Blog - Zichen's Website</title>
    <link rel="icon" type="image/webp" href="img/index/avatar.webp">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Blog filters responsive layout */
        #blog-filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group select,
        .filter-group input,
        .filter-group button {
            cursor: pointer;
        }

        /* Large screens: search on left, others on right */
        @media (min-width: 1200px) {
            #blog-filters-container {
                gap: 1.5rem;
            }
            
            .search-group {
                order: 1;
                flex: 1;
                min-width: 300px;
            }

            .filter-group:not(.search-group):not(.clear-group) {
                order: 2;
                flex-shrink: 0;
            }

            .clear-group {
                display: none;
            }
        }

        /* Medium screens: search on first row, others on second */
        @media (min-width: 768px) and (max-width: 1199px) {
            #blog-filters-container {
                gap: 1rem;
            }

            .search-group {
                flex-basis: 100%;
                order: 1;
            }

            .filter-group:not(.search-group):not(.clear-group) {
                flex-basis: calc(33.33% - 0.67rem);
                order: 2;
            }

            .clear-group {
                display: none;
            }
        }

        /* Small screens: search, clear, then dropdowns */
        @media (max-width: 767px) {
            #blog-filters-container {
                gap: 0.6rem;
            }

            .search-group {
                flex-basis: 100%;
                order: 1;
            }

            .clear-group {
                flex-basis: 100%;
                order: 2;
                justify-content: center;
            }

            .filter-group:not(.search-group):not(.clear-group) {
                flex-basis: calc(33.33% - 0.4rem);
                order: 3;
            }

            .filter-group select {
                width: 100%;
            }

            #search-input {
                width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Ê†èÂç†‰ΩçÁ¨¶ -->
    <div id="navbar-placeholder"></div>

    <!-- ‰∏ªÂÜÖÂÆπ -->
    <main class="main-content">
        <div class="container">
            <section class="section">
                <h1 class="text-center" id="page-title">Blog Posts | ÊàëÁöÑÂçöÂÆ¢</h1>
                <p class="text-center hero-subtitle" id="page-subtitle">Record learning, share thoughts, deliver value</p>
            </section>

            <!-- Blog Categories, Tags, Search and Sort -->
            <section class="section">
                <div id="blog-filters-container">
                    <!-- Search Box -->
                    <div class="filter-group search-group">
                        <input type="text" id="search-input" class="btn btn-outline" style="flex: 1; padding: 0.5rem; background: var(--input-bg, #f0f0f0); border: 1px solid var(--border-color, #ddd); border-radius: 4px;" placeholder="Search..." title="Search by title or content" onkeyup="performSearch()">
                    </div>

                    <!-- Category Dropdown -->
                    <div class="filter-group">
                        <select id="category-select" class="btn btn-outline" title="Category" onchange="filterByCategory()">
                            <option value="all" id="opt-cat-all">All</option>
                            <option value="tech" id="opt-cat-tech">Tech</option>
                            <option value="life" id="opt-cat-life">Life</option>
                            <option value="study" id="opt-cat-study">Study</option>
                        </select>
                    </div>

                    <!-- Tags Filter -->
                    <div class="filter-group">
                        <select id="tags-select" class="btn btn-outline" title="Tags" onchange="filterByTags()">
                            <option value="" id="opt-all-tags" selected>All Tags</option>
                        </select>
                    </div>

                    <!-- Sort Dropdown -->
                    <div class="filter-group">
                        <select id="blog-sort" class="btn btn-outline" title="Sort" onchange="applySort()">
                            <option value="date-desc" id="opt-date-desc">Time (newest first)</option>
                            <option value="date-asc" id="opt-date-asc">Time (oldest first)</option>
                            <option value="zh-asc" id="opt-zh-asc">Chinese title (A-Z)</option>
                            <option value="zh-desc" id="opt-zh-desc">Chinese title (Z-A)</option>
                            <option value="en-asc" id="opt-en-asc">English title (A-Z)</option>
                            <option value="en-desc" id="opt-en-desc">English title (Z-A)</option>
                        </select>
                    </div>

                    <!-- Clear Search Button -->
                    <div class="filter-group clear-group">
                        <button class="btn btn-outline" id="clear-search-btn" style="padding: 0.5rem 1rem;" onclick="clearSearch()">Clear</button>
                    </div>
                </div>
            </section>

            <!-- Blog List -->
            <section class="section">
                <div id="blog-list" class="blog-list">
                    <!-- Blogs will be loaded dynamically via JavaScript -->
                    <div class="text-center">
                        <div class="loading"></div>
                        <p id="loading-text">Loading blog posts...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- È°µËÑöÂç†‰ΩçÁ¨¶ -->
    <div id="footer-placeholder"></div>

    <script src="js/language.js"></script>
    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Blog filtering functionality
        let allBlogs = [];
        let activeCategory = 'all';
        let activeSort = 'date-desc';
        let activeTag = '';
        let searchQuery = '';

        function getBlogText(value) {
            return getLocalizedText(value);
        }

        function getBlogTitleBoth(value) {
            return getLocalizedBlogTitle(value);
        }

        // Ëé∑ÂèñÊâÄÊúâÂîØ‰∏ÄÊ†áÁ≠æ
        function getAllUniqueTags() {
            const tagsSet = new Set();
            allBlogs.forEach(blog => {
                if (blog.tags && Array.isArray(blog.tags)) {
                    blog.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            return Array.from(tagsSet).sort();
        }

        // ÂàùÂßãÂåñÊ†áÁ≠æÈÄâÊã©Ê°Ü
        function initializeTagsSelect() {
            const tagsSelect = document.getElementById('tags-select');
            const allTags = getAllUniqueTags();
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïô"All Tags"Ôºâ
            const allTagsOption = tagsSelect.querySelector('[id="opt-all-tags"]');
            tagsSelect.innerHTML = '';
            tagsSelect.appendChild(allTagsOption);
            
            // Ê∑ªÂä†ÊâÄÊúâÊ†áÁ≠æ
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagsSelect.appendChild(option);
            });
        }
        
        function updateBlogPageLanguage() {
            // Update category options
            document.getElementById('opt-cat-all').textContent = translateBlog('catAll');
            document.getElementById('opt-cat-tech').textContent = translateBlog('catTech');
            document.getElementById('opt-cat-life').textContent = translateBlog('catLife');
            document.getElementById('opt-cat-study').textContent = translateBlog('catStudy');
            
            // Update tags label
            document.getElementById('opt-all-tags').textContent = translateBlog('allTags');
            
            // Update search label and placeholder
            document.getElementById('search-input').placeholder = translateBlog('searchPlaceholder');
            document.getElementById('clear-search-btn').textContent = translateBlog('clearSearch');
            
            // Update sort options
            document.getElementById('opt-date-desc').textContent = translateBlog('sortTime');
            document.getElementById('opt-date-asc').textContent = translateBlog('sortTimeOld');
            document.getElementById('opt-zh-asc').textContent = translateBlog('sortZhAsc');
            document.getElementById('opt-zh-desc').textContent = translateBlog('sortZhDesc');
            document.getElementById('opt-en-asc').textContent = translateBlog('sortEnAsc');
            document.getElementById('opt-en-desc').textContent = translateBlog('sortEnDesc');
            
            // Update loading text
            document.getElementById('loading-text').textContent = translateBlog('loading');
        }
        
        async function initBlogList() {
            updateBlogPageLanguage();
            allBlogs = await loadBlogList();
            initializeTagsSelect();
            applySort();
            
            // ÁõëÂê¨ËØ≠Ë®ÄÂèòÂåñ
            window.addEventListener('languageChanged', () => {
                updateBlogPageLanguage();
                applySort();
            });
        }
        
        function displayBlogs(blogs) {
            const blogListContainer = document.getElementById('blog-list');
            
            if (blogs.length === 0) {
                blogListContainer.innerHTML = `<div class="text-center"><p>${translateBlog('noBlogs')}</p></div>`;
                return;
            }
            
            blogListContainer.innerHTML = blogs.map(blog => {
                const title = getBlogTitleBoth(blog.title);
                const excerpt = getBlogText(blog.excerpt);
                const readTime = getBlogText(blog.readTime) || '5 min read';
                return `
                <div class="blog-card" onclick="location.href='blog-detail.html?id=${blog.id}'">
                    <div class="blog-header">
                        <h3 class="blog-title">${title}</h3>
                        <div class="blog-meta">
                            <span>üìÖ ${blog.date}</span>
                            <span>‚è±Ô∏è ${readTime}</span>
                            ${blog.category ? `<span>üìÅ ${blog.category}</span>` : ''}
                        </div>
                    </div>
                    <div class="blog-excerpt">
                        ${excerpt}
                    </div>
                    ${blog.tags ? `
                        <div class="blog-tags">
                            ${blog.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        function applySort() {
            const sortSelect = document.getElementById('blog-sort');
            if (sortSelect) {
                activeSort = sortSelect.value;
            }

            const filtered = getFilteredAndSearchedBlogs();
            const sorted = sortBlogs(filtered, activeSort);
            displayBlogs(sorted);
        }

        function getFilteredAndSearchedBlogs() {
            let filtered = allBlogs;

            // ÊåâÁ±ªÂà´ËøáÊª§
            if (activeCategory !== 'all') {
                filtered = filtered.filter(blog =>
                    blog.category === activeCategory
                );
            }

            // ÊåâÊ†áÁ≠æËøáÊª§
            if (activeTag) {
                filtered = filtered.filter(blog =>
                    blog.tags && blog.tags.includes(activeTag)
                );
            }

            // ÊåâÊêúÁ¥¢ËØçËøáÊª§
            if (searchQuery.trim()) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(blog => {
                    const titleText = (blog.title && typeof blog.title === 'object' 
                        ? `${blog.title.en || ''} ${blog.title.zh || ''}` 
                        : String(blog.title)).toLowerCase();
                    const excerptText = (blog.excerpt && typeof blog.excerpt === 'object'
                        ? `${blog.excerpt.en || ''} ${blog.excerpt.zh || ''}`
                        : String(blog.excerpt)).toLowerCase();
                    return titleText.includes(query) || excerptText.includes(query);
                });
            }

            return filtered;
        }

        function sortBlogs(blogs, sortKey) {
            const [field, direction] = sortKey.split('-');
            const multiplier = direction === 'desc' ? -1 : 1;
            const dateValue = value => new Date(value).getTime() || 0;
            const currentLang = getCurrentLanguage();

            return [...blogs].sort((a, b) => {
                if (field === 'date') {
                    return (dateValue(a.date) - dateValue(b.date)) * multiplier;
                }
                if (field === 'zh') {
                    const aText = (a.title && a.title.zh) ? a.title.zh : '';
                    const bText = (b.title && b.title.zh) ? b.title.zh : '';
                    return aText.localeCompare(bText, 'zh-Hans-CN') * multiplier;
                }
                if (field === 'en') {
                    const aText = (a.title && a.title.en) ? a.title.en : '';
                    const bText = (b.title && b.title.en) ? b.title.en : '';
                    return aText.localeCompare(bText, 'en') * multiplier;
                }
                return 0;
            });
        }
        
        function filterByCategory() {
            const categorySelect = document.getElementById('category-select');
            activeCategory = categorySelect.value;
            applySort();
        }

        function filterByTags() {
            const tagsSelect = document.getElementById('tags-select');
            activeTag = tagsSelect.value;
            applySort();
        }

        function performSearch() {
            const searchInput = document.getElementById('search-input');
            searchQuery = searchInput.value;
            applySort();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            searchQuery = '';
            applySort();
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', initBlogList);
    </script>
</body>
</html>
